<html class="h-full bg-gray-900" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   TikTok-like App with Firebase - Profile Photo &amp; Username
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter&amp;display=swap" rel="stylesheet"/>
  <style>
   body, html {
      font-family: 'Inter', sans-serif;
      height: 100%;
      margin: 0;
      background-color: #111827;
      color: white;
    }
    /* Hide default video controls for custom styling */
    video::-internal-media-controls-overlay-cast-button,
    video::-webkit-media-controls {
      display:none !important;
    }
    /* Scrollbar for comments */
    .comments-scroll {
      max-height: 150px;
      overflow-y: auto;
    }
  </style>
 </head>
 <body class="h-full flex flex-col">
  <div class="flex flex-col h-full" id="app">
   <!-- Login/Register Modal -->
   <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4" id="auth-modal">
    <div class="bg-gray-800 rounded-lg max-w-md w-full p-6 space-y-6 shadow-lg">
     <h2 class="text-3xl font-bold text-center" id="auth-title">
      Login
     </h2>
     <form class="space-y-4" id="auth-form">
      <input class="w-full px-4 py-3 rounded bg-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="email" placeholder="Email" required="" type="email"/>
      <input class="w-full px-4 py-3 rounded bg-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="password" placeholder="Password" required="" type="password"/>
      <button class="w-full bg-indigo-600 hover:bg-indigo-700 transition rounded py-3 font-semibold text-lg" type="submit">
       Login
      </button>
     </form>
     <p class="text-center text-gray-400">
      <span id="auth-toggle-text">
       Don't have an account?
      </span>
      <button class="text-indigo-500 font-semibold hover:underline focus:outline-none" id="auth-toggle-btn">
       Register
      </button>
     </p>
     <p class="text-red-500 text-center text-sm mt-2" id="auth-error">
     </p>
    </div>
   </div>
   <!-- Main App -->
   <div class="hidden flex-1 flex flex-col relative" id="main-app">
    <!-- Video Feed -->
    <div class="flex-1 relative overflow-hidden" id="video-feed">
     <!-- Videos will be appended here dynamically -->
    </div>
    <!-- Bottom Navigation -->
    <nav class="bg-gray-900 border-t border-gray-700 flex justify-around items-center h-16">
     <button aria-label="Home" class="flex flex-col items-center justify-center text-indigo-500" id="nav-home">
      <i class="fas fa-home fa-lg">
      </i>
      <span class="text-xs mt-1">
       Home
      </span>
     </button>
     <button aria-label="Upload" class="flex flex-col items-center justify-center text-gray-400 hover:text-indigo-500 focus:outline-none" id="nav-upload">
      <i class="fas fa-plus-circle fa-lg">
      </i>
      <span class="text-xs mt-1">
       Upload
      </span>
     </button>
     <button aria-label="Profile" class="flex flex-col items-center justify-center text-gray-400 hover:text-indigo-500 focus:outline-none" id="nav-profile">
      <i class="fas fa-user fa-lg">
      </i>
      <span class="text-xs mt-1">
       Profile
      </span>
     </button>
    </nav>
    <!-- Upload Modal -->
    <div aria-labelledby="upload-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4 hidden" id="upload-modal" role="dialog">
     <div class="bg-gray-800 rounded-lg max-w-md w-full p-6 space-y-6 shadow-lg">
      <h2 class="text-3xl font-bold text-center" id="upload-title">
       Upload Video or Photo
      </h2>
      <form class="space-y-4" id="upload-form">
       <input accept="video/*,image/*" aria-label="Select video or photo file" class="w-full text-gray-300" id="media-file" required="" type="file"/>
       <input aria-label="Caption" class="w-full px-4 py-3 rounded bg-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="caption" placeholder="Caption (optional)" type="text"/>
       <button class="w-full bg-indigo-600 hover:bg-indigo-700 transition rounded py-3 font-semibold text-lg" type="submit">
        Post
       </button>
      </form>
      <button class="w-full mt-2 text-center text-indigo-500 hover:underline focus:outline-none" id="upload-close">
       Cancel
      </button>
      <p aria-live="assertive" class="text-red-500 text-center text-sm mt-2" id="upload-error" role="alert">
      </p>
     </div>
    </div>
    <!-- Profile Modal -->
    <div aria-labelledby="profile-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4 hidden" id="profile-modal" role="dialog">
     <div class="bg-gray-800 rounded-lg max-w-md w-full p-6 space-y-6 shadow-lg flex flex-col items-center">
      <h2 class="text-3xl font-bold mb-4" id="profile-title">
       Your Profile
      </h2>
      <form class="w-full max-w-sm flex flex-col items-center space-y-4" id="profile-form">
       <div class="relative w-28 h-28">
        <img alt="User profile picture" aria-label="Profile picture" class="rounded-full w-28 h-28 object-cover border-4 border-indigo-600 cursor-pointer" height="112" id="profile-pic" src="https://storage.googleapis.com/a1aa/image/e95e7ab0-a4d4-4e0a-c816-dd5643747e75.jpg" tabindex="0" width="112"/>
        <input accept="image/*" aria-label="Upload profile picture" class="hidden" id="profile-pic-input" type="file"/>
        <div aria-label="Edit profile picture" class="absolute bottom-0 right-0 bg-indigo-600 rounded-full p-2 cursor-pointer" id="profile-pic-edit" role="button" tabindex="0">
         <i class="fas fa-camera text-white">
         </i>
        </div>
       </div>
       <input aria-label="Username" class="w-full px-4 py-3 rounded bg-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white" id="username" maxlength="30" placeholder="Username" type="text"/>
       <p class="text-gray-400 text-sm text-center">
        You can set your display username here.
       </p>
       <button class="w-full bg-indigo-600 hover:bg-indigo-700 transition rounded py-3 font-semibold text-lg" id="profile-save-btn" type="submit">
        Save Profile
       </button>
       <button class="w-full mt-2 text-center text-indigo-500 hover:underline focus:outline-none" id="profile-close">
        Close
       </button>
       <p aria-live="assertive" class="text-red-500 text-center text-sm mt-2" id="profile-error" role="alert">
       </p>
       <p aria-live="polite" class="text-green-500 text-center text-sm mt-2" id="profile-success" role="alert">
       </p>
      </form>
     </div>
    </div>
   </div>
  </div>
  <!-- Firebase SDKs -->
  <script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase,
      ref as dbRef,
      push,
      onValue,
      query,
      orderByChild,
      limitToLast,
      update,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getStorage,
      ref as storageRef,
      uploadBytesResumable,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAgOPD5DDtjExQaVeu6VLFI7CMP9i8VOQw",
      authDomain: "projectchat01-d16bc.firebaseapp.com",
      databaseURL: "https://projectchat01-d16bc-default-rtdb.firebaseio.com",
      projectId: "projectchat01-d16bc",
      storageBucket: "projectchat01-d16bc.appspot.com",
      messagingSenderId: "163313653543",
      appId: "1:163313653543:web:cd1c193158d8a76811bb02",
      measurementId: "G-VG80CY31FG"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // DOM Elements
    const authModal = document.getElementById('auth-modal');
    const authTitle = document.getElementById('auth-title');
    const authForm = document.getElementById('auth-form');
    const authToggleBtn = document.getElementById('auth-toggle-btn');
    const authToggleText = document.getElementById('auth-toggle-text');
    const authError = document.getElementById('auth-error');

    const mainApp = document.getElementById('main-app');
    const videoFeed = document.getElementById('video-feed');

    const navHome = document.getElementById('nav-home');
    const navUpload = document.getElementById('nav-upload');
    const navProfile = document.getElementById('nav-profile');

    const uploadModal = document.getElementById('upload-modal');
    const uploadForm = document.getElementById('upload-form');
    const uploadClose = document.getElementById('upload-close');
    const uploadError = document.getElementById('upload-error');
    const mediaFileInput = document.getElementById('media-file');
    const captionInput = document.getElementById('caption');

    const profileModal = document.getElementById('profile-modal');
    const profileEmail = document.getElementById('profile-email');
    const logoutBtn = document.getElementById('logout-btn');
    const profileClose = document.getElementById('profile-close');
    const profilePic = document.getElementById('profile-pic');
    const profilePicInput = document.getElementById('profile-pic-input');
    const profilePicEdit = document.getElementById('profile-pic-edit');
    const usernameInput = document.getElementById('username');
    const profileForm = document.getElementById('profile-form');
    const profileError = document.getElementById('profile-error');
    const profileSuccess = document.getElementById('profile-success');

    // State
    let isLoginMode = true;

    // Toggle between Login and Register
    authToggleBtn.addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      if (isLoginMode) {
        authTitle.textContent = 'Login';
        authToggleText.textContent = "Don't have an account?";
        authToggleBtn.textContent = 'Register';
        authForm.querySelector('button').textContent = 'Login';
      } else {
        authTitle.textContent = 'Register';
        authToggleText.textContent = "Already have an account?";
        authToggleBtn.textContent = 'Login';
        authForm.querySelector('button').textContent = 'Register';
      }
      authError.textContent = '';
    });

    // Handle Login/Register form submit
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.textContent = '';
      const email = authForm.email.value.trim();
      const password = authForm.password.value.trim();

      if (!email || !password) {
        authError.textContent = 'Please fill in all fields.';
        return;
      }

      try {
        if (isLoginMode) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (error) {
        authError.textContent = error.message;
      }
    });

    // Handle logout
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    // Show upload modal
    navUpload.addEventListener('click', () => {
      uploadModal.classList.remove('hidden');
      uploadError.textContent = '';
      uploadForm.reset();
    });

    // Close upload modal
    uploadClose.addEventListener('click', () => {
      uploadModal.classList.add('hidden');
      uploadError.textContent = '';
      uploadForm.reset();
    });

    // Close profile modal
    profileClose.addEventListener('click', () => {
      profileModal.classList.add('hidden');
      profileError.textContent = '';
      profileSuccess.textContent = '';
    });

    // Show profile modal and load profile data
    navProfile.addEventListener('click', async () => {
      if (auth.currentUser) {
        profileError.textContent = '';
        profileSuccess.textContent = '';
        profileModal.classList.remove('hidden');
        usernameInput.value = '';
        profilePic.src = "https://placehold.co/112x112/png?text=Profile+Photo";

        // Load profile data from Realtime Database
        const userProfileRef = dbRef(database, `users/${auth.currentUser.uid}`);
        try {
          const snapshot = await get(userProfileRef);
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (data.username) usernameInput.value = data.username;
            if (data.photoURL) profilePic.src = data.photoURL;
          } else {
            // No profile data yet, use default
            usernameInput.value = '';
            profilePic.src = "https://placehold.co/112x112/png?text=Profile+Photo";
          }
        } catch (error) {
          profileError.textContent = 'Failed to load profile: ' + error.message;
        }
      }
    });

    // Profile picture edit click triggers file input
    profilePicEdit.addEventListener('click', () => {
      profilePicInput.click();
    });
    profilePicEdit.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        profilePicInput.click();
      }
    });
    profilePic.addEventListener('click', () => {
      profilePicInput.click();
    });
    profilePic.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        profilePicInput.click();
      }
    });

    // Handle profile picture file selection and preview
    let uploadedProfilePicFile = null;
    profilePicInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        profileError.textContent = 'Only image files are allowed for profile picture.';
        return;
      }
      profileError.textContent = '';
      uploadedProfilePicFile = file;
      const reader = new FileReader();
      reader.onload = (event) => {
        profilePic.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Save profile form submit
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      profileError.textContent = '';
      profileSuccess.textContent = '';

      const username = usernameInput.value.trim();
      if (username.length > 30) {
        profileError.textContent = 'Username must be 30 characters or less.';
        return;
      }
      if (!auth.currentUser) {
        profileError.textContent = 'You must be logged in to update profile.';
        return;
      }

      try {
        const user = auth.currentUser;
        let photoURL = profilePic.src;

        // If user uploaded a new profile pic file, upload it to Firebase Storage
        if (uploadedProfilePicFile) {
          const storagePath = `profile_pictures/${user.uid}/${Date.now()}_${uploadedProfilePicFile.name}`;
          const fileRef = storageRef(storage, storagePath);
          const uploadTask = uploadBytesResumable(fileRef, uploadedProfilePicFile);

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed', null, reject, resolve);
          });

          photoURL = await getDownloadURL(uploadTask.snapshot.ref);
        }

        // Update user profile in Firebase Auth (displayName and photoURL)
        await updateProfile(user, {
          displayName: username || null,
          photoURL: photoURL || null
        });

        // Save profile data in Realtime Database under users/{uid}
        const userProfileRef = dbRef(database, `users/${user.uid}`);
        await update(userProfileRef, {
          username: username || null,
          photoURL: photoURL || null
        });

        profileSuccess.textContent = 'Profile updated successfully.';
        uploadedProfilePicFile = null;
      } catch (error) {
        profileError.textContent = 'Failed to update profile: ' + error.message;
      }
    });

    // Render posts in feed with likes, comments, and show username & profile pic
    function renderPost(postData, postId) {
      const { mediaURL, mediaType, caption, email, likes = 0, likedBy = {}, comments = {}, uid } = postData;

      const postEl = document.createElement('div');
      postEl.className = 'absolute inset-0 flex flex-col justify-center items-center bg-black';

      // Media container
      const mediaContainer = document.createElement('div');
      mediaContainer.className = 'flex-1 flex justify-center items-center w-full max-h-full relative';

      if (mediaType === 'video') {
        const video = document.createElement('video');
        video.src = mediaURL;
        video.controls = false;
        video.autoplay = true;
        video.loop = true;
        video.muted = true;
        video.playsInline = true;
        video.className = 'max-h-full max-w-full object-contain rounded-lg shadow-lg';
        mediaContainer.appendChild(video);

        // Play/pause toggle on tap
        mediaContainer.addEventListener('click', () => {
          if (video.paused) video.play();
          else video.pause();
        });
      } else if (mediaType === 'image') {
        const img = document.createElement('img');
        img.src = mediaURL;
        img.alt = caption || 'User uploaded image';
        img.className = 'max-h-full max-w-full object-contain rounded-lg shadow-lg';
        mediaContainer.appendChild(img);
      }
      postEl.appendChild(mediaContainer);

      // Overlay container bottom left for caption and user info
      const infoOverlay = document.createElement('div');
      infoOverlay.className = 'absolute bottom-24 left-6 max-w-[80vw] bg-black bg-opacity-50 rounded p-3 text-white text-sm shadow-lg flex items-center space-x-3';

      // Profile pic small circle
      const userPic = document.createElement('img');
      userPic.alt = `Profile picture of user ${email}`;
      userPic.className = 'w-8 h-8 rounded-full object-cover border border-indigo-500 flex-shrink-0';
      userPic.src = "https://placehold.co/32x32/png?text=User"; // default placeholder

      // Load user profile pic and username from users/{uid}
      if (uid) {
        const userProfileRef = dbRef(database, `users/${uid}`);
        get(userProfileRef).then(snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (data.photoURL) userPic.src = data.photoURL;
            if (data.username) {
              usernameSpan.textContent = data.username;
            } else {
              usernameSpan.textContent = email;
            }
          } else {
            usernameSpan.textContent = email;
          }
        }).catch(() => {
          usernameSpan.textContent = email;
        });
      } else {
        usernameSpan.textContent = email;
      }

      // Username text
      const usernameSpan = document.createElement('span');
      usernameSpan.className = 'font-semibold break-words';

      infoOverlay.appendChild(userPic);
      infoOverlay.appendChild(usernameSpan);

      // Caption text below username
      const captionP = document.createElement('p');
      captionP.className = 'break-words mt-1 text-sm max-w-[70vw]';
      captionP.textContent = caption || '';
      const captionContainer = document.createElement('div');
      captionContainer.className = 'flex flex-col';
      captionContainer.appendChild(infoOverlay);
      captionContainer.appendChild(captionP);

      // Replace infoOverlay with captionContainer for better layout
      postEl.appendChild(captionContainer);

      // Likes and comments container bottom right
      const actionsOverlay = document.createElement('div');
      actionsOverlay.className = 'absolute bottom-24 right-6 flex flex-col items-center space-y-6 text-white text-center select-none';

      // Like button
      const likeBtn = document.createElement('button');
      likeBtn.className = 'flex flex-col items-center focus:outline-none';
      likeBtn.setAttribute('aria-label', 'Like post');
      const likeIcon = document.createElement('i');
      likeIcon.className = 'fas fa-heart fa-2x cursor-pointer transition-colors';
      likeBtn.appendChild(likeIcon);
      const likeCount = document.createElement('span');
      likeCount.className = 'text-sm mt-1 select-text';
      likeCount.textContent = likes;
      likeBtn.appendChild(likeCount);

      // Set initial like color if user liked
      const currentUser = auth.currentUser;
      if (currentUser && likedBy[currentUser.uid]) {
        likeIcon.classList.add('text-red-500');
      } else {
        likeIcon.classList.remove('text-red-500');
      }

      likeBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!currentUser) {
          alert('You must be logged in to like posts.');
          return;
        }
        const postRef = dbRef(database, `posts/${postId}`);
        try {
          const snapshot = await get(postRef);
          if (!snapshot.exists()) return;
          const post = snapshot.val();
          const likedByMap = post.likedBy || {};
          let newLikes = post.likes || 0;
          if (likedByMap[currentUser.uid]) {
            // Unlike
            delete likedByMap[currentUser.uid];
            newLikes = Math.max(0, newLikes - 1);
            likeIcon.classList.remove('text-red-500');
          } else {
            // Like
            likedByMap[currentUser.uid] = true;
            newLikes = newLikes + 1;
            likeIcon.classList.add('text-red-500');
          }
          await update(postRef, { likedBy: likedByMap, likes: newLikes });
          likeCount.textContent = newLikes;
        } catch (error) {
          alert('Error updating like: ' + error.message);
        }
      });

      actionsOverlay.appendChild(likeBtn);

      // Comments button to toggle comments panel
      const commentBtn = document.createElement('button');
      commentBtn.className = 'flex flex-col items-center focus:outline-none';
      commentBtn.setAttribute('aria-label', 'Show comments');
      const commentIcon = document.createElement('i');
      commentIcon.className = 'fas fa-comment fa-2x cursor-pointer';
      commentBtn.appendChild(commentIcon);
      const commentCount = document.createElement('span');
      commentCount.className = 'text-sm mt-1 select-text';
      commentCount.textContent = Object.keys(comments).length;
      commentBtn.appendChild(commentCount);

      actionsOverlay.appendChild(commentBtn);

      postEl.appendChild(actionsOverlay);

      // Comments panel (hidden by default)
      const commentsPanel = document.createElement('div');
      commentsPanel.className = 'absolute bottom-0 left-0 right-0 bg-gray-900 bg-opacity-95 p-4 max-h-[50vh] flex flex-col space-y-3 hidden';
      commentsPanel.style.zIndex = '1000';

      // Comments header with close button
      const commentsHeader = document.createElement('div');
      commentsHeader.className = 'flex justify-between items-center border-b border-gray-700 pb-2';
      const commentsTitle = document.createElement('h3');
      commentsTitle.className = 'text-lg font-semibold';
      commentsTitle.textContent = 'Comments';
      const commentsCloseBtn = document.createElement('button');
      commentsCloseBtn.className = 'text-indigo-500 hover:underline focus:outline-none';
      commentsCloseBtn.textContent = 'Close';
      commentsCloseBtn.addEventListener('click', () => {
        commentsPanel.classList.add('hidden');
      });
      commentsHeader.appendChild(commentsTitle);
      commentsHeader.appendChild(commentsCloseBtn);
      commentsPanel.appendChild(commentsHeader);

      // Comments list container
      const commentsList = document.createElement('div');
      commentsList.className = 'comments-scroll overflow-y-auto flex-1 space-y-2 text-sm text-gray-300';
      commentsPanel.appendChild(commentsList);

      // Comment form
      const commentForm = document.createElement('form');
      commentForm.className = 'flex space-x-2 mt-2';
      const commentInput = document.createElement('input');
      commentInput.type = 'text';
      commentInput.placeholder = 'Add a comment...';
      commentInput.className = 'flex-1 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      commentInput.setAttribute('aria-label', 'Add a comment');
      const commentSubmit = document.createElement('button');
      commentSubmit.type = 'submit';
      commentSubmit.textContent = 'Post';
      commentSubmit.className = 'bg-indigo-600 hover:bg-indigo-700 transition rounded px-4 py-2 font-semibold';
      commentForm.appendChild(commentInput);
      commentForm.appendChild(commentSubmit);
      commentsPanel.appendChild(commentForm);

      postEl.appendChild(commentsPanel);

      // Show/hide comments panel on comment button click
      commentBtn.addEventListener('click', () => {
        if (commentsPanel.classList.contains('hidden')) {
          commentsPanel.classList.remove('hidden');
          commentInput.focus();
        } else {
          commentsPanel.classList.add('hidden');
        }
      });

      // Render comments list
      function renderComments(commentsObj) {
        commentsList.innerHTML = '';
        const sortedComments = Object.entries(commentsObj || {}).sort((a,b) => a[1].timestamp - b[1].timestamp);
        if (sortedComments.length === 0) {
          const noComments = document.createElement('p');
          noComments.className = 'text-gray-500 italic text-center';
          noComments.textContent = 'No comments yet.';
          commentsList.appendChild(noComments);
          return;
        }
        sortedComments.forEach(([commentId, comment]) => {
          const commentEl = document.createElement('div');
          commentEl.className = 'border border-gray-700 rounded p-2 bg-gray-800';
          commentEl.innerHTML = `<span class="font-semibold text-indigo-400">${escapeHtml(comment.email)}</span>: ${escapeHtml(comment.text)}`;
          commentsList.appendChild(commentEl);
        });
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        return text.replace(/[&<>"']/g, function(m) {
          return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
        });
      }

      // Listen for comments updates realtime
      const commentsRef = dbRef(database, `posts/${postId}/comments`);
      onValue(commentsRef, (snapshot) => {
        const commentsData = snapshot.val() || {};
        commentCount.textContent = Object.keys(commentsData).length;
        renderComments(commentsData);
      });

      // Handle comment form submit
      commentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!auth.currentUser) {
          alert('You must be logged in to comment.');
          return;
        }
        const text = commentInput.value.trim();
        if (!text) return;
        const commentData = {
          uid: auth.currentUser.uid,
          email: auth.currentUser.email,
          text,
          timestamp: Date.now()
        };
        try {
          const newCommentRef = push(dbRef(database, `posts/${postId}/comments`));
          await newCommentRef.set(commentData);
          commentInput.value = '';
        } catch (error) {
          alert('Error posting comment: ' + error.message);
        }
      });

      return postEl;
    }

    // Load posts from Firebase Realtime Database and show newest first
    function loadPosts() {
      const postsRef = query(dbRef(database, 'posts'), orderByChild('timestamp'), limitToLast(100));
      onValue(postsRef, (snapshot) => {
        const posts = [];
        snapshot.forEach(childSnap => {
          posts.push({ id: childSnap.key, ...childSnap.val() });
        });
        // Sort descending by timestamp
        posts.sort((a, b) => b.timestamp - a.timestamp);

        // Clear feed
        videoFeed.innerHTML = '';

        // Show posts one at a time full screen with vertical swipe navigation
        if (posts.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'flex flex-col justify-center items-center h-full text-gray-400 text-center px-4';
          emptyMsg.innerHTML = '<i class="fas fa-video-slash fa-3x mb-4"></i><p>No posts yet. Upload your first video or photo!</p>';
          videoFeed.appendChild(emptyMsg);
          return;
        }

        // Create container for all posts
        const container = document.createElement('div');
        container.className = 'h-full w-full relative overflow-hidden';

        // Create each post element and position vertically
        posts.forEach((post, index) => {
          const postEl = renderPost(post, post.id);
          postEl.style.top = `${index * 100}vh`;
          postEl.style.position = 'absolute';
          postEl.style.width = '100%';
          postEl.style.height = '100%';
          container.appendChild(postEl);
        });

        videoFeed.appendChild(container);

        // Implement vertical swipe navigation
        let currentIndex = 0;
        let startY = 0;
        let isDragging = false;

        function setTranslateY(y) {
          container.style.transform = `translateY(${y}px)`;
        }

        function clampIndex(i) {
          if (i < 0) return 0;
          if (i >= posts.length) return posts.length - 1;
          return i;
        }

        videoFeed.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            startY = e.touches[0].clientY;
            isDragging = true;
          }
        });

        videoFeed.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          const currentY = e.touches[0].clientY;
          const diff = currentY - startY;
          setTranslateY(-currentIndex * window.innerHeight + diff);
        });

        videoFeed.addEventListener('touchend', (e) => {
          if (!isDragging) return;
          isDragging = false;
          const endY = e.changedTouches[0].clientY;
          const diff = endY - startY;
          if (diff < -50 && currentIndex < posts.length - 1) {
            currentIndex++;
          } else if (diff > 50 && currentIndex > 0) {
            currentIndex--;
          }
          container.style.transition = 'transform 0.3s ease';
          setTranslateY(-currentIndex * window.innerHeight);
          setTimeout(() => {
            container.style.transition = '';
          }, 300);
        });

        // Also allow mouse wheel for desktop
        videoFeed.addEventListener('wheel', (e) => {
          if (e.deltaY > 30 && currentIndex < posts.length - 1) {
            currentIndex++;
          } else if (e.deltaY < -30 && currentIndex > 0) {
            currentIndex--;
          } else {
            return;
          }
          container.style.transition = 'transform 0.3s ease';
          setTranslateY(-currentIndex * window.innerHeight);
          setTimeout(() => {
            container.style.transition = '';
          }, 300);
        });
      });
    }

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authModal.classList.add('hidden');
        mainApp.classList.remove('hidden');
        loadPosts();
      } else {
        authModal.classList.remove('hidden');
        mainApp.classList.add('hidden');
        videoFeed.innerHTML = '';
      }
    });
  </script>
 </body>
</html>
