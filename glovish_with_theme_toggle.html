<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>GloVish - Blue Themed Social App</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      font-family: "Inter", sans-serif;
    }
    /* Scrollbar for chat and comments */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
  </style>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile,
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";
    import {
      getDatabase,
      ref as dbRef,
      set,
      get,
      child,
      onValue,
      push,
      query,
      orderByChild,
      equalTo,
      limitToLast,
      update,
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAgOPD5DDtjExQaVeu6VLFI7CMP9i8VOQw",
      authDomain: "projectchat01-d16bc.firebaseapp.com",
      databaseURL:
        "https://projectchat01-d16bc-default-rtdb.firebaseio.com",
      projectId: "projectchat01-d16bc",
      storageBucket: "projectchat01-d16bc.appspot.com",
      messagingSenderId: "163313653543",
      appId: "1:163313653543:web:5a4c8b70d6dedb8011bb02",
      measurementId: "G-M8JFL7S0TV",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const database = getDatabase(app);

    // Elements
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    const profileForm = document.getElementById("profile-form");
    const logoutBtn = document.getElementById("logout-btn");
    const navLogin = document.getElementById("nav-login");
    const navRegister = document.getElementById("nav-register");
    const navProfile = document.getElementById("nav-profile");
    const navFeed = document.getElementById("nav-feed");
    const navPrivateChat = document.getElementById("nav-private-chat");
    const navLeaderboard = document.getElementById("nav-leaderboard");
    const pages = document.querySelectorAll(".page");
    const userNameDisplay = document.getElementById("user-name-display");
    const userPhotoDisplay = document.getElementById("user-photo-display");
    const feedContainer = document.getElementById("feed-container");
    const leaderboardContainer = document.getElementById("leaderboard-container");
    const uploadVideoForm = document.getElementById("upload-video-form");
    const uploadVideoInput = document.getElementById("upload-video-input");
    const uploadVideoPreview = document.getElementById("upload-video-preview");
    const uploadVideoTitle = document.getElementById("upload-video-title");
    const uploadVideoDesc = document.getElementById("upload-video-desc");

    // Photo upload elements
    const uploadPhotoForm = document.getElementById("upload-photo-form");
    const uploadPhotoInput = document.getElementById("upload-photo-input");
    const uploadPhotoPreview = document.getElementById("upload-photo-preview");
    const uploadPhotoTitle = document.getElementById("upload-photo-title");
    const uploadPhotoDesc = document.getElementById("upload-photo-desc");

    // Chat and comments elements
    const commentsList = document.getElementById("comments-list");
    const commentForm = document.getElementById("comment-form");
    const commentInput = document.getElementById("comment-input");
    const commentVideoTitle = document.getElementById("comment-video-title");
    const commentVideoIdInput = document.getElementById("comment-video-id");
    const commentVideoOwnerIdInput = document.getElementById("comment-video-owner-id");

    // Private chat elements
    const privateChatSection = document.getElementById("private-chat-section");
    const privateChatList = document.getElementById("private-chat-list");
    const privateChatForm = document.getElementById("private-chat-form");
    const privateChatInput = document.getElementById("private-chat-input");
    const privateChatUserSelect = document.getElementById("private-chat-user-select");
    const privateChatMessages = document.getElementById("private-chat-messages");
    const privateChatTitle = document.getElementById("private-chat-title");
    const privateChatBackBtn = document.getElementById("private-chat-back-btn");

    // Android-like bottom navigation GUI
    document.addEventListener("DOMContentLoaded", () => {
      const bottomNavButtons = document.querySelectorAll("#bottom-nav button");
      bottomNavButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-target");
          showPage(target);
        });
      });
    });

    // Navigation function
    function showPage(pageId) {
      pages.forEach((page) => {
        if (page.id === pageId) {
          page.classList.remove("hidden");
        } else {
          page.classList.add("hidden");
        }
      });
      if (pageId === "feed-page") {
        loadFeed();
      }
      if (pageId === "leaderboard-page") {
        loadLeaderboard();
      }
      if (pageId === "private-chat-page") {
        loadUsersForPrivateChat();
        privateChatSection.classList.add("hidden");
        privateChatList.classList.remove("hidden");
        privateChatMessages.innerHTML = "";
        privateChatTitle.textContent = "Private Chats";
        privateChatBackBtn.style.display = "none";
      }
      if (pageId !== "video-comments-page") {
        clearComments();
      }
    }

    // Initial page: show login or feed depending on auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userNameDisplay.textContent = user.displayName || user.email;
        if (user.photoURL) {
          userPhotoDisplay.src = user.photoURL;
          userPhotoDisplay.alt = `Profile photo of ${user.displayName || user.email}`;
        } else {
          userPhotoDisplay.src = "https://placehold.co/100x100/png?text=No+Photo";
          userPhotoDisplay.alt = "Default profile photo placeholder";
        }
        navLogin.style.display = "none";
        navRegister.style.display = "none";
        navProfile.style.display = "inline-block";
        navFeed.style.display = "inline-block";
        navPrivateChat.style.display = "inline-block";
        navLeaderboard.style.display = "inline-block";
        logoutBtn.style.display = "inline-block";
        showPage("feed-page");
        loadFeed();
      } else {
        userNameDisplay.textContent = "";
        userPhotoDisplay.src = "https://placehold.co/100x100/png?text=No+Photo";
        userPhotoDisplay.alt = "Default profile photo placeholder";
        navLogin.style.display = "none";
        navRegister.style.display = "none";
        navProfile.style.display = "none";
        navFeed.style.display = "none";
        navPrivateChat.style.display = "none";
        navLeaderboard.style.display = "none";
        logoutBtn.style.display = "none";
        showPage("login-page");
      }
    });

    // Register
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = registerForm.email.value.trim();
      const password = registerForm.password.value;
      const username = registerForm.username.value.trim();

      if (!email || !password || !username) {
        alert("Please fill all fields");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(
          auth,
          email,
          password
        );
        const user = userCredential.user;
        await updateProfile(user, { displayName: username });
        // Save user profile in realtime database
        await set(dbRef(database, "users/" + user.uid), {
          username: username,
          email: email,
          photoURL: "",
        });
        alert("Registration successful!");
        registerForm.reset();
        showPage("login-page");
      } catch (error) {
        alert(error.message);
      }
    });

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = loginForm.email.value.trim();
      const password = loginForm.password.value;

      if (!email || !password) {
        alert("Please fill all fields");
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginForm.reset();
      } catch (error) {
        alert(error.message);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Profile update
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("No user logged in");
        return;
      }
      const newUsername = profileForm.username.value.trim();
      const photoFile = profileForm.photo.files[0];

      if (!newUsername) {
        alert("Username cannot be empty");
        return;
      }

      try {
        let photoURL = user.photoURL || "";
        if (photoFile) {
          const photoStorageRef = storageRef(
            storage,
            "profilePhotos/" + user.uid + "/" + photoFile.name
          );
          await uploadBytes(photoStorageRef, photoFile);
          photoURL = await getDownloadURL(photoStorageRef);
        }
        await updateProfile(user, {
          displayName: newUsername,
          photoURL: photoURL,
        });
        await set(dbRef(database, "users/" + user.uid), {
          username: newUsername,
          email: user.email,
          photoURL: photoURL,
        });
        alert("Profile updated!");
        userNameDisplay.textContent = newUsername;
        if (photoURL) {
          userPhotoDisplay.src = photoURL;
          userPhotoDisplay.alt = `Profile photo of ${newUsername}`;
        }
        profileForm.reset();
      } catch (error) {
        alert(error.message);
      }
    });

    // Upload video (simulate TikTok video upload)
    uploadVideoForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to upload videos");
        return;
      }
      const videoFile = uploadVideoInput.files[0];
      const title = uploadVideoTitle.value.trim();
      const description = uploadVideoDesc.value.trim();

      if (!videoFile || !title) {
        alert("Please select a video and enter a title");
        return;
      }

      try {
        const videoStorageRef = storageRef(
          storage,
          "videos/" + user.uid + "/" + Date.now() + "_" + videoFile.name
        );
        await uploadBytes(videoStorageRef, videoFile);
        const videoURL = await getDownloadURL(videoStorageRef);

        // Save video metadata in realtime database with empty likes object
        const videoData = {
          uid: user.uid,
          username: user.displayName || user.email,
          photoURL: user.photoURL || "",
          videoURL: videoURL,
          title: title,
          description: description,
          timestamp: Date.now(),
          likes: {}, // store user ids who liked
          type: "video",
          monthYear: getCurrentMonthYear(),
        };

        const newVideoRef = dbRef(database, "posts/" + Date.now());
        await set(newVideoRef, videoData);

        alert("Video uploaded!");
        uploadVideoForm.reset();
        uploadVideoPreview.src = "";
        loadFeed();
      } catch (error) {
        alert(error.message);
      }
    });

    // Upload photo (new feature)
    uploadPhotoForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to upload photos");
        return;
      }
      const photoFile = uploadPhotoInput.files[0];
      const title = uploadPhotoTitle.value.trim();
      const description = uploadPhotoDesc.value.trim();

      if (!photoFile || !title) {
        alert("Please select a photo and enter a title");
        return;
      }

      try {
        const photoStorageRef = storageRef(
          storage,
          "photos/" + user.uid + "/" + Date.now() + "_" + photoFile.name
        );
        await uploadBytes(photoStorageRef, photoFile);
        const photoURL = await getDownloadURL(photoStorageRef);

        // Save photo metadata in realtime database with empty likes object
        const photoData = {
          uid: user.uid,
          username: user.displayName || user.email,
          photoURL: user.photoURL || "",
          imageURL: photoURL,
          title: title,
          description: description,
          timestamp: Date.now(),
          likes: {}, // store user ids who liked
          type: "photo",
          monthYear: getCurrentMonthYear(),
        };

        const newPhotoRef = dbRef(database, "posts/" + Date.now());
        await set(newPhotoRef, photoData);

        alert("Photo uploaded!");
        uploadPhotoForm.reset();
        uploadPhotoPreview.src = "";
        loadFeed();
      } catch (error) {
        alert(error.message);
      }
    });

    // Preview video on file select
    uploadVideoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        uploadVideoPreview.src = url;
        uploadVideoPreview.classList.remove("hidden");
      } else {
        uploadVideoPreview.src = "";
        uploadVideoPreview.classList.add("hidden");
      }
    });

    // Preview photo on file select
    uploadPhotoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        uploadPhotoPreview.src = url;
        uploadPhotoPreview.classList.remove("hidden");
      } else {
        uploadPhotoPreview.src = "";
        uploadPhotoPreview.classList.add("hidden");
      }
    });

    // Load feed posts (videos and photos) from database
    async function loadFeed() {
      feedContainer.innerHTML = "";
      const dbPostsRef = dbRef(database, "posts");
      try {
        const snapshot = await get(dbPostsRef);
        if (snapshot.exists()) {
          // Sort posts by timestamp descending
          const posts = Object.entries(snapshot.val())
            .map(([key, val]) => ({ id: key, ...val }))
            .sort((a, b) => b.timestamp - a.timestamp);
          posts.forEach((post) => {
            const postCard = document.createElement("div");
            postCard.className =
              "mb-8 rounded-lg shadow-lg bg-white overflow-hidden max-w-md mx-auto";

            // Count likes
            const likesCount = post.likes ? Object.keys(post.likes).length : 0;
            // Check if current user liked
            const user = auth.currentUser;
            const userLiked = user && post.likes && post.likes[user.uid];

            let mediaHtml = "";
            if (post.type === "video") {
              mediaHtml = `<video controls src="${post.videoURL}" class="w-full max-h-[400px] bg-black" preload="metadata" playsinline></video>`;
            } else if (post.type === "photo") {
              mediaHtml = `<img src="${post.imageURL}" alt="Photo titled ${post.title}" class="w-full object-cover max-h-[400px]" />`;
            }

            postCard.innerHTML = `
              <div class="flex items-center p-4 space-x-4">
                <img src="${
                  post.photoURL ||
                  "https://placehold.co/50x50/png?text=User"
                }" alt="Profile photo of ${post.username}" class="w-12 h-12 rounded-full object-cover" />
                <div class="flex-1">
                  <h3 class="font-semibold text-lg">${post.username}</h3>
                  <p class="text-gray-500 text-sm">${new Date(
                    post.timestamp
                  ).toLocaleString()}</p>
                </div>
                <button data-postid="${post.id}" data-posttype="${post.type}" data-postowner="${post.uid}" class="open-comments-btn text-blue-600 hover:text-red-800 focus:outline-none" aria-label="Open comments for post titled ${post.title}">
                  <i class="fas fa-comments fa-lg"></i>
                </button>
              </div>
              ${mediaHtml}
              <div class="p-4 flex flex-col space-y-2">
                <h4 class="font-semibold text-md">${post.title}</h4>
                <p class="text-gray-700 text-sm">${post.description}</p>
                <div class="flex items-center space-x-4">
                  <button aria-label="Like button" data-postid="${post.id}" class="like-btn flex items-center space-x-1 text-sm ${
                    userLiked ? "text-blue-600" : "text-gray-600"
                  } hover:text-blue-600 focus:outline-none">
                    <i class="fas fa-heart fa-lg"></i>
                    <span>${likesCount}</span>
                  </button>
                </div>
              </div>
            `;
            feedContainer.appendChild(postCard);
          });
          // Add event listeners for comment buttons
          document.querySelectorAll(".open-comments-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const postId = btn.getAttribute("data-postid");
              const postType = btn.getAttribute("data-posttype");
              const postOwner = btn.getAttribute("data-postowner");
              openComments(postId, postType, postOwner);
            });
          });
          // Add event listeners for like buttons
          document.querySelectorAll(".like-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const postId = btn.getAttribute("data-postid");
              const user = auth.currentUser;
              if (!user) {
                alert("You must be logged in to like posts");
                return;
              }
              const postRef = dbRef(database, "posts/" + postId + "/likes/" + user.uid);
              try {
                const snapshot = await get(postRef);
                if (snapshot.exists()) {
                  // User already liked, remove like
                  await set(postRef, null);
                } else {
                  // Add like
                  await set(postRef, true);
                }
                loadFeed();
              } catch (error) {
                alert(error.message);
              }
            });
          });
        } else {
          feedContainer.innerHTML =
            '<p class="text-center text-gray-500">No posts uploaded yet.</p>';
        }
      } catch (error) {
        feedContainer.innerHTML =
          '<p class="text-center text-red-500">Failed to load posts.</p>';
      }
    }

    // Comments functionality
    function openComments(postId, postType, postOwnerId) {
      // Load post title for comments header
      const postRef = dbRef(database, "posts/" + postId);
      get(postRef).then((snapshot) => {
        if (snapshot.exists()) {
          const post = snapshot.val();
          commentVideoTitle.textContent = post.title || "Post";
        } else {
          commentVideoTitle.textContent = "Post";
        }
      });
      commentVideoIdInput.value = postId;
      commentVideoOwnerIdInput.value = postOwnerId;
      showPage("video-comments-page");
      loadComments(postId);
    }

    function clearComments() {
      commentsList.innerHTML = "";
      commentInput.value = "";
      commentVideoTitle.textContent = "";
      commentVideoIdInput.value = "";
      commentVideoOwnerIdInput.value = "";
    }

    async function loadComments(postId) {
      commentsList.innerHTML = '<p class="text-center text-gray-500">Loading comments...</p>';
      const commentsRef = dbRef(database, "comments/" + postId);
      onValue(commentsRef, (snapshot) => {
        commentsList.innerHTML = "";
        if (snapshot.exists()) {
          const comments = Object.values(snapshot.val()).sort(
            (a, b) => a.timestamp - b.timestamp
          );
          comments.forEach((comment) => {
            const commentEl = document.createElement("div");
            commentEl.className = "flex items-start space-x-3 p-2 border-b border-gray-200";
            commentEl.innerHTML = `
              <img src="${comment.photoURL || "https://placehold.co/40x40/png?text=User"}" alt="Profile photo of ${comment.username}" class="w-10 h-10 rounded-full object-cover flex-shrink-0" />
              <div>
                <p class="text-sm font-semibold">${comment.username}</p>
                <p class="text-gray-700 text-sm">${comment.text}</p>
                <p class="text-xs text-gray-400">${new Date(comment.timestamp).toLocaleString()}</p>
              </div>
            `;
            commentsList.appendChild(commentEl);
          });
        } else {
          commentsList.innerHTML = '<p class="text-center text-gray-500">No comments yet.</p>';
        }
      });
    }

    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to comment");
        return;
      }
      const text = commentInput.value.trim();
      if (!text) {
        alert("Comment cannot be empty");
        return;
      }
      const postId = commentVideoIdInput.value;
      if (!postId) {
        alert("Invalid post");
        return;
      }
      const commentData = {
        uid: user.uid,
        username: user.displayName || user.email,
        photoURL: user.photoURL || "",
        text: text,
        timestamp: Date.now(),
      };
      try {
        const newCommentRef = push(dbRef(database, "comments/" + postId));
        await set(newCommentRef, commentData);
        commentInput.value = "";
      } catch (error) {
        alert(error.message);
      }
    });

    // Private chat functionality
    async function loadUsersForPrivateChat() {
      const user = auth.currentUser;
      if (!user) return;
      privateChatUserSelect.innerHTML =
        '<option value="" disabled selected>Select user to chat</option>';
      try {
        const usersRef = dbRef(database, "users");
        const snapshot = await get(usersRef);
        if (snapshot.exists()) {
          const users = snapshot.val();
          Object.entries(users).forEach(([uid, userData]) => {
            if (uid !== user.uid) {
              const option = document.createElement("option");
              option.value = uid;
              option.textContent =
                userData.username || userData.email || "Unknown";
              privateChatUserSelect.appendChild(option);
            }
          });
        }
      } catch (error) {
        alert("Failed to load users for chat");
      }
    }

    privateChatUserSelect.addEventListener("change", () => {
      const otherUserId = privateChatUserSelect.value;
      if (!otherUserId) return;
      openPrivateChat(otherUserId);
    });

    function getChatRoomId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    let currentChatRoomId = null;
    let currentChatOtherUserId = null;
    let currentChatOtherUserName = null;
    let currentChatOtherUserPhoto = null;
    let chatMessagesListener = null;

    async function openPrivateChat(otherUserId) {
      const user = auth.currentUser;
      if (!user) return;
      currentChatRoomId = getChatRoomId(user.uid, otherUserId);
      currentChatOtherUserId = otherUserId;

      try {
        const otherUserSnap = await get(dbRef(database, "users/" + otherUserId));
        if (otherUserSnap.exists()) {
          const otherUserData = otherUserSnap.val();
          currentChatOtherUserName =
            otherUserData.username || otherUserData.email || "Unknown";
          currentChatOtherUserPhoto =
            otherUserData.photoURL || "https://placehold.co/40x40/png?text=User";
        } else {
          currentChatOtherUserName = "Unknown";
          currentChatOtherUserPhoto = "https://placehold.co/40x40/png?text=User";
        }
      } catch {
        currentChatOtherUserName = "Unknown";
        currentChatOtherUserPhoto = "https://placehold.co/40x40/png?text=User";
      }

      privateChatTitle.textContent = `Chat with ${currentChatOtherUserName}`;
      privateChatList.classList.add("hidden");
      privateChatSection.classList.remove("hidden");
      privateChatInput.value = "";
      privateChatInput.focus();
      privateChatBackBtn.style.display = "inline-block";
      loadPrivateChatMessages();
    }

    function loadPrivateChatMessages() {
      if (chatMessagesListener) {
        chatMessagesListener();
        chatMessagesListener = null;
      }
      privateChatMessages.innerHTML =
        '<p class="text-center text-gray-500">Loading messages...</p>';
      const messagesRef = dbRef(database, "privateChats/" + currentChatRoomId);
      chatMessagesListener = onValue(messagesRef, (snapshot) => {
        privateChatMessages.innerHTML = "";
        if (snapshot.exists()) {
          const messages = Object.values(snapshot.val()).sort(
            (a, b) => a.timestamp - b.timestamp
          );
          messages.forEach((msg) => {
            const isCurrentUser = msg.uid === auth.currentUser.uid;
            const msgEl = document.createElement("div");
            msgEl.className = `flex ${
              isCurrentUser ? "justify-end" : "justify-start"
            } mb-2`;
            msgEl.innerHTML = `
              <div class="max-w-xs px-4 py-2 rounded-lg ${
                isCurrentUser ? "bg-blue-600 text-white" : "bg-gray-200 text-gray-900"
              } break-words">
                <p class="text-sm">${msg.text}</p>
                <p class="text-xs mt-1 text-gray-300">${new Date(
                  msg.timestamp
                ).toLocaleTimeString()}</p>
              </div>
            `;
            privateChatMessages.appendChild(msgEl);
          });
          privateChatMessages.scrollTop = privateChatMessages.scrollHeight;
        } else {
          privateChatMessages.innerHTML =
            '<p class="text-center text-gray-500">No messages yet.</p>';
        }
      });
    }

    privateChatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to chat");
        return;
      }
      const text = privateChatInput.value.trim();
      if (!text) {
        alert("Message cannot be empty");
        return;
      }
      if (!currentChatRoomId) {
        alert("No chat room selected");
        return;
      }
      const messageData = {
        uid: user.uid,
        text: text,
        timestamp: Date.now(),
      };
      try {
        const newMsgRef = push(dbRef(database, "privateChats/" + currentChatRoomId));
        await set(newMsgRef, messageData);
        privateChatInput.value = "";
      } catch (error) {
        alert(error.message);
      }
    });

    privateChatBackBtn.addEventListener("click", () => {
      if (chatMessagesListener) {
        chatMessagesListener();
        chatMessagesListener = null;
      }
      privateChatSection.classList.add("hidden");
      privateChatList.classList.remove("hidden");
      privateChatTitle.textContent = "Private Chats";
      privateChatMessages.innerHTML = "";
      currentChatRoomId = null;
      currentChatOtherUserId = null;
      privateChatBackBtn.style.display = "none";
      privateChatUserSelect.value = "";
    });

    // Helper to get current month-year string like "2024-06"
    function getCurrentMonthYear() {
      const now = new Date();
      return now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0");
    }

    // Load leaderboard: top posts by likes this month
    async function loadLeaderboard() {
      leaderboardContainer.innerHTML = '<p class="text-center text-gray-500">Loading leaderboard...</p>';
      const currentMonthYear = getCurrentMonthYear();
      const postsRef = dbRef(database, "posts");
      try {
        const snapshot = await get(postsRef);
        if (snapshot.exists()) {
          const posts = Object.entries(snapshot.val())
            .map(([key, val]) => ({ id: key, ...val }))
            .filter((post) => post.monthYear === currentMonthYear);
          if (posts.length === 0) {
            leaderboardContainer.innerHTML = '<p class="text-center text-gray-500">No posts this month.</p>';
            return;
          }
          // Sort by likes count descending
          posts.sort((a, b) => {
            const aLikes = a.likes ? Object.keys(a.likes).length : 0;
            const bLikes = b.likes ? Object.keys(b.likes).length : 0;
            return bLikes - aLikes;
          });
          leaderboardContainer.innerHTML = "";
          posts.forEach((post, index) => {
            const likesCount = post.likes ? Object.keys(post.likes).length : 0;
            const postEl = document.createElement("div");
            postEl.className = "flex items-center space-x-4 p-3 border-b border-gray-200";
            postEl.innerHTML = `
              <div class="text-lg font-bold w-8 text-center">${index + 1}</div>
              <img src="${post.photoURL || "https://placehold.co/50x50/png?text=User"}" alt="Profile photo of ${post.username}" class="w-12 h-12 rounded-full object-cover" />
              <div class="flex-1">
                <div class="font-semibold">${post.username}</div>
                <div class="text-sm text-gray-600">${post.title}</div>
              </div>
              <div class="flex items-center space-x-1 text-blue-600 font-semibold">
                <i class="fas fa-heart"></i>
                <span>${likesCount}</span>
              </div>
            `;
            leaderboardContainer.appendChild(postEl);
          });
        } else {
          leaderboardContainer.innerHTML = '<p class="text-center text-gray-500">No posts found.</p>';
        }
      } catch (error) {
        leaderboardContainer.innerHTML = '<p class="text-center text-red-500">Failed to load leaderboard.</p>';
      }
    }

    // Reset monthly likes (optional: can be triggered manually or via backend/cloud function)
    // This function resets likes for posts not in current monthYear
    async function resetOldLikes() {
      const currentMonthYear = getCurrentMonthYear();
      const postsRef = dbRef(database, "posts");
      try {
        const snapshot = await get(postsRef);
        if (snapshot.exists()) {
          const updates = {};
          Object.entries(snapshot.val()).forEach(([key, post]) => {
            if (post.monthYear !== currentMonthYear && post.likes) {
              updates[key + "/likes"] = null;
            }
          });
          if (Object.keys(updates).length > 0) {
            await update(postsRef, updates);
          }
        }
      } catch (error) {
        console.error("Failed to reset old likes:", error);
      }
    }

    // Call resetOldLikes on app start (optional)
    resetOldLikes();

  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
<header class="bg-white shadow-md sticky top-0 z-10">
<nav aria-label="Main navigation" class="max-w-4xl mx-auto flex items-center justify-between p-4" role="navigation">
<div class="text-2xl font-bold text-blue-600 flex items-center space-x-2">
<span>GloVish</span>
</div>
<ul class="hidden md:flex space-x-6 text-gray-700 font-semibold">
<li>
<button class="hover:text-blue-600" id="nav-feed">Feed</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-profile">Profile</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-private-chat" style="display:none;">Private Chat</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-leaderboard" style="display:none;">Leaderboard</button>
</li>
<li>
<button class="hover:text-blue-600" id="nav-upload">Upload</button>
</li>
</ul>
<button class="hidden bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" id="logout-btn">
        Logout
      </button>
<div class="space-x-2" id="auth-buttons">
<button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" id="open-login-modal">
        Login
      </button>
<button class="bg-gray-200 text-blue-600 px-3 py-1 rounded hover:bg-gray-300" id="open-register-modal">
        Register
      </button>
</div>

<button class="ml-4 text-sm text-blue-600 hover:underline" id="toggle-theme">
      üåô Dark Mode
    </button>
</nav>
</header>
<main class="flex-grow max-w-4xl mx-auto w-full p-4">
<!-- Login Page -->
<!-- Register Page -->
<!-- Profile Page -->
<section class="page hidden" id="profile-page">
<h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">Profile</h2>
<div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md space-y-6">
<div class="flex flex-col items-center space-y-4">
<img alt="GloVish Default Profile" class="w-24 h-24 rounded-full object-cover border-2 border-blue-600" height="100" id="user-photo-display" src="https://i.imgur.com/qCjHhMH.png" width="100"/>
<h3 class="text-xl font-semibold text-gray-800" id="user-name-display"></h3>
<div class="flex space-x-6 mt-2">
<div class="text-center">
<div class="text-xl font-bold text-gray-800" id="following-count">0</div>
<div class="text-sm text-gray-500">Mengikuti</div>
</div>
<div class="text-center">
<div class="text-xl font-bold text-gray-800" id="followers-count">0</div>
<div class="text-sm text-gray-500">Pengikut</div>
</div>
</div></div>
<form class="space-y-4" id="profile-form">
<div>
<label class="block mb-1 font-medium text-gray-700" for="username">Change Username</label>
<input class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="username" name="username" placeholder="New username" required="" type="text"/>
</div>
<div>
<label class="block mb-1 font-medium text-gray-700" for="photo">Change Profile Photo</label>
<input accept="image/*" class="w-full" id="photo" name="photo" type="file"/>
</div>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition" type="submit">
            Update Profile
          </button>
</form>
</div>
</section>
<!-- Feed Page -->
<section class="page hidden" id="feed-page">
<h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">Feed</h2>
<div class="max-w-md mx-auto mb-6">
<input aria-label="Search users" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="user-search-input" placeholder="Search users by username..." type="search"/>
<div aria-live="polite" aria-relevant="additions" class="bg-white rounded shadow mt-2 max-h-48 overflow-y-auto scrollbar-thin" id="user-search-results" role="listbox" tabindex="0">
<!-- Search results appear here -->
</div>
</div>
<div class="space-y-6" id="feed-container"></div>
</section>
<!-- Video Comments Page -->
<section class="page hidden" id="video-comments-page">
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-4 flex flex-col h-[80vh]">
<header class="flex items-center justify-between border-b border-gray-300 pb-2 mb-4">
<h3 class="text-xl font-semibold" id="comment-video-title">Post Title</h3>
<button aria-label="Back to feed" class="text-blue-600 hover:text-red-800 focus:outline-none" id="comments-back-btn">
<i class="fas fa-times fa-lg"></i>
</button>
</header>
<div aria-live="polite" aria-relevant="additions" class="flex-grow overflow-y-auto scrollbar-thin" id="comments-list" tabindex="0">
<!-- Comments will be loaded here -->
</div>
<form aria-label="Add comment form" class="mt-4 flex space-x-2" id="comment-form">
<input aria-label="Add a comment" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="comment-input" placeholder="Add a comment..." required="" type="text"/>
<input id="comment-video-id" type="hidden"/>
<input id="comment-video-owner-id" type="hidden"/>
<button aria-label="Send comment" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition" type="submit">
            Send
          </button>
</form>
</div>
</section>
<!-- Private Chat Page -->
<section class="page hidden" id="private-chat-page">
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-4 flex flex-col h-[80vh]">
<header class="flex items-center justify-between border-b border-gray-300 pb-2 mb-4">
<h3 class="text-xl font-semibold" id="private-chat-title">Private Chats</h3>
<button aria-label="Back to feed" class="text-blue-600 hover:text-red-800 focus:outline-none" id="private-chat-back-btn" style="display:none;">
<i class="fas fa-arrow-left fa-lg"></i>
</button>
</header>
<div aria-live="polite" aria-relevant="additions" class="overflow-y-auto scrollbar-thin flex-grow space-y-2" id="private-chat-list" tabindex="0">
<label class="block font-semibold mb-1" for="private-chat-user-select">Start chat with:</label>
<select aria-label="Select user to chat" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" id="private-chat-user-select">
<option disabled="" selected="" value="">Loading users...</option>
</select>
</div>
<div class="hidden flex flex-col flex-grow" id="private-chat-section">
<div aria-live="polite" aria-relevant="additions" class="flex-grow overflow-y-auto scrollbar-thin p-2 border border-gray-300 rounded mb-4" id="private-chat-messages" style="min-height: 200px;" tabindex="0">
<!-- Messages will appear here -->
</div>
<form aria-label="Send private chat message form" class="flex space-x-2" id="private-chat-form">
<input aria-label="Type a message" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="private-chat-input" placeholder="Type a message..." required="" type="text"/>
<button aria-label="Send message" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition" type="submit">
              Send
            </button>
</form>
</div>
</div>
</section>
<!-- Leaderboard Page -->
<section aria-label="Leaderboard" class="page hidden" id="leaderboard-page">
<h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">
        Monthly Leaderboard
      </h2>
<div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-4 space-y-2" id="leaderboard-container">
<!-- Leaderboard entries will be loaded here -->
</div>
</section>
<section class="page hidden" id="upload-page"><h2 class="text-3xl font-semibold mb-6 text-center text-gray-800">Upload Media</h2></section></main>
<!-- Android-like bottom navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 flex justify-around items-center h-16 md:hidden z-20" id="bottom-nav">
<button aria-label="Feed" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="feed-page">
<i class="fas fa-home fa-lg"></i>
<span class="text-xs mt-1">Feed</span>
</button>
<button aria-label="Upload" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="upload-page">
<i class="fas fa-upload fa-lg"></i>
<span class="text-xs mt-1">Upload</span>
</button>
<button aria-label="Profile" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="profile-page">
<i class="fas fa-user fa-lg"></i>
<span class="text-xs mt-1">Profile</span>
</button>
<button aria-label="Private Chat" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="private-chat-page">
<i class="fas fa-comments fa-lg"></i>
<span class="text-xs mt-1">Chat</span>
</button>
<button aria-label="Leaderboard" class="flex flex-col items-center justify-center text-gray-600 hover:text-blue-600 focus:outline-none" data-target="leaderboard-page">
<i class="fas fa-trophy fa-lg"></i>
<span class="text-xs mt-1">Leaderboard</span>
</button>
</nav>
<script>
    // Show/hide video preview on file select
    const uploadVideoInput = document.getElementById("upload-video-input");
    const uploadVideoPreview = document.getElementById("upload-video-preview");
    uploadVideoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        uploadVideoPreview.src = url;
        uploadVideoPreview.classList.remove("hidden");
      } else {
        uploadVideoPreview.src = "";
        uploadVideoPreview.classList.add("hidden");
      }
    });

    // Show/hide photo preview on file select
    const uploadPhotoInput = document.getElementById("upload-photo-input");
    const uploadPhotoPreview = document.getElementById("upload-photo-preview");
    uploadPhotoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        uploadPhotoPreview.src = url;
        uploadPhotoPreview.classList.remove("hidden");
      } else {
        uploadPhotoPreview.src = "";
        uploadPhotoPreview.classList.add("hidden");
      }
    });

    // Comments back button
    const commentsBackBtn = document.getElementById("comments-back-btn");
    commentsBackBtn.addEventListener("click", () => {
      showPage("feed-page");
    });

    // Show register page from login page
    const showRegisterBtn = document.getElementById("show-register-btn");
    showRegisterBtn.addEventListener("click", () => {
      showPage("register-page");
    });

    // Show login page from register page
    const showLoginBtn = document.getElementById("show-login-btn");
    showLoginBtn.addEventListener("click", () => {
      showPage("login-page");
    });
  </script>
<!-- Login Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="login-modal">
<div class="bg-white p-6 rounded shadow-lg w-96">
<h2 class="text-xl font-semibold mb-4 text-center">Login</h2>
<form class="space-y-4" id="login-form">
<input class="w-full border px-3 py-2 rounded" name="email" placeholder="Email" required="" type="email"/>
<input class="w-full border px-3 py-2 rounded" name="password" placeholder="Password" required="" type="password"/>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Login</button>
<p class="text-sm text-center text-gray-600">Belum punya akun? <button class="text-blue-600 hover:underline" id="switch-to-register" type="button">Daftar</button></p>
</form>
</div>
</div>
<!-- Register Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" id="register-modal">
<div class="bg-white p-6 rounded shadow-lg w-96">
<h2 class="text-xl font-semibold mb-4 text-center">Register</h2>
<form class="space-y-4" id="register-form">
<input class="w-full border px-3 py-2 rounded" name="username" placeholder="Username" required="" type="text"/>
<input class="w-full border px-3 py-2 rounded" name="email" placeholder="Email" required="" type="email"/>
<input class="w-full border px-3 py-2 rounded" name="password" placeholder="Password" required="" type="password"/>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Register</button>
<p class="text-sm text-center text-gray-600">Sudah punya akun? <button class="text-blue-600 hover:underline" id="switch-to-login" type="button">Login</button></p>
</form>
</div>
</div>
<script>
  const loginModal = document.getElementById("login-modal");
  const registerModal = document.getElementById("register-modal");

  document.getElementById("open-login-modal")?.addEventListener("click", () => {
    loginModal.classList.remove("hidden");
  });

  document.getElementById("open-register-modal")?.addEventListener("click", () => {
    registerModal.classList.remove("hidden");
  });

  document.getElementById("switch-to-register")?.addEventListener("click", () => {
    loginModal.classList.add("hidden");
    registerModal.classList.remove("hidden");
  });

  document.getElementById("switch-to-login")?.addEventListener("click", () => {
    registerModal.classList.add("hidden");
    loginModal.classList.remove("hidden");
  });

  window.addEventListener("click", (e) => {
    if (e.target === loginModal) loginModal.classList.add("hidden");
    if (e.target === registerModal) registerModal.classList.add("hidden");
  });
</script>
<script>
document.getElementById("nav-upload")?.addEventListener("click", () => showPage("upload-page"));
</script><script>
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const followingRef = dbRef(database, "following/" + user.uid);
    const followersRef = dbRef(database, "followers/" + user.uid);

    try {
      const [followingSnap, followersSnap] = await Promise.all([
        get(followingRef),
        get(followersRef),
      ]);

      const followingCount = followingSnap.exists() ? Object.keys(followingSnap.val()).length : 0;
      const followersCount = followersSnap.exists() ? Object.keys(followersSnap.val()).length : 0;

      document.getElementById("following-count").textContent = followingCount;
      document.getElementById("followers-count").textContent = followersCount;
    } catch (err) {
      console.error("Error fetching follower data:", err);
    }
  }
});
</script><style>
.dark {
  background-color: #1a202c;
  color: #edf2f7;
}
.dark input,
.dark textarea,
.dark select {
  background-color: #2d3748;
  color: #edf2f7;
  border-color: #4a5568;
}
.dark .bg-white {
  background-color: #2d3748 !important;
}
.dark .text-gray-700,
.dark .text-gray-500,
.dark .text-gray-600 {
  color: #cbd5e0 !important;
}
.dark .border-gray-300 {
  border-color: #4a5568 !important;
}
</style><script>
document.getElementById("toggle-theme")?.addEventListener("click", () => {
  const body = document.body;
  const btn = document.getElementById("toggle-theme");
  const dark = body.classList.toggle("dark");

  if (dark) {
    btn.textContent = "‚òÄÔ∏è Light Mode";
    localStorage.setItem("theme", "dark");
  } else {
    btn.textContent = "üåô Dark Mode";
    localStorage.setItem("theme", "light");
  }
});

// Apply theme on load
window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    const btn = document.getElementById("toggle-theme");
    if (btn) btn.textContent = "‚òÄÔ∏è Light Mode";
  }
});
</script></body>
</html>