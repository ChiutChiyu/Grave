<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Media App</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, push, get, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_ID",
      appId: "YOUR_APP_ID",
      databaseURL: "YOUR_DB_URL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();
    const storage = getStorage();

    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('.section');

    function switchTab(tabId) {
      sections.forEach(s => s.hidden = true);
      document.getElementById(tabId).hidden = false;

      if (tabId === 'upload') {
        fileInput.value = '';
        uploadTitleInput.value = '';
        uploadDescriptionInput.value = '';
        uploadPreviewContainer.hidden = true;
        uploadPreview.innerHTML = '';
        uploadBtn.disabled = true;
      }
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    const register = async () => {
      const email = registerEmail.value;
      const password = registerPassword.value;
      try {
        document.querySelector('button[onclick="register()"]').disabled = true;
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert("Gagal register: " + e.message);
      } finally {
        document.querySelector('button[onclick="register()"]').disabled = false;
      }
    }

    const login = async () => {
      const email = loginEmail.value;
      const password = loginPassword.value;
      try {
        document.querySelector('button[onclick="login()"]').disabled = true;
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert("Gagal login: " + e.message);
      } finally {
        document.querySelector('button[onclick="login()"]').disabled = false;
      }
    }

    function logout() {
      auth.signOut();
    }
    window.logout = logout;

    const loadHomeFeed = async () => {
      const snapshot = await get(ref(db, 'posts'));
      if (!snapshot.exists()) return homeFeed.innerHTML = '<p>Tidak ada postingan.</p>';

      const posts = Object.entries(snapshot.val()).map(([id, val]) => ({ id, ...val })).reverse();

      const commentsMap = {};
      const likesMap = {};
      await Promise.all(posts.map(async post => {
        const cSnap = await get(ref(db, `comments/${post.id}`));
        commentsMap[post.id] = cSnap.exists() ? Object.values(cSnap.val()) : [];

        const lSnap = await get(ref(db, `likes/${post.id}`));
        likesMap[post.id] = lSnap.exists() ? Object.keys(lSnap.val()).length : 0;
      }));

      homeFeed.innerHTML = '';
      posts.forEach(post => {
        const postEl = document.createElement('div');
        postEl.className = "p-4 border rounded mb-4";

        postEl.innerHTML = `
          <p><strong>${post.name}</strong> <span class="text-xs text-gray-500">(${post.time})</span></p>
          <p class="text-lg font-semibold">${post.title}</p>
          <p>${post.description}</p>
          ${post.type.startsWith('image') ?
            `<img src="${post.url}" class="mt-2 max-h-64 rounded" />` :
            `<video controls class="mt-2 w-full max-h-64 rounded"><source src="${post.url}" type="${post.type}"></video>`
          }
          <button onclick="toggleLike('${post.id}')" id="likeBtn-${post.id}" class="mt-3 text-sm text-gray-600 hover:text-blue-500">
            ❤️ Suka
          </button>
          <span id="likeCount-${post.id}" class="text-sm ml-2">${likesMap[post.id]}</span>

          <div class="mt-4">
            <form onsubmit="addComment('${post.id}', this); return false;" class="flex items-center gap-2">
              <input type="text" placeholder="Tulis komentar..." class="flex-1 border rounded px-3 py-1 text-sm" required />
              <button type="submit" class="text-sm text-blue-600 hover:underline">Kirim</button>
            </form>
            <ul id="comments-${post.id}" class="mt-2 space-y-1 text-sm text-gray-700"></ul>
          </div>
        `;
        homeFeed.appendChild(postEl);

        const commentsEl = postEl.querySelector(`#comments-${post.id}`);
        commentsMap[post.id].forEach(c => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${c.user}:</strong> ${c.text} <span class="text-xs text-gray-400">(${c.time})</span>`;
          commentsEl.appendChild(li);
        });
      });
    }

    window.toggleLike = async (postId) => {
      const user = auth.currentUser;
      if (!user) return alert("Login untuk menyukai.");
      const likeRef = ref(db, `likes/${postId}/${user.uid}`);
      const snap = await get(likeRef);
      await set(likeRef, snap.exists() ? null : true);
      loadHomeFeed();
    }

    window.addComment = function(postId, form) {
      const text = form.querySelector('input').value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user) return alert("Login dulu.");
      get(ref(db, 'users/' + user.uid)).then(snap => {
        const name = snap.val()?.name || user.email.split('@')[0];
        const cRef = push(ref(db, `comments/${postId}`));
        set(cRef, {
          user: name,
          text,
          time: new Date().toLocaleString()
        });
        form.reset();
        loadHomeFeed();
      });
    }

    const updateProfile = async () => {
      const user = auth.currentUser;
      const name = profileName.value;
      const email = profileEmail.value;
      const updates = { name, email };
      const file = profileImage.files[0];

      if (file) {
        const fileRef = sRef(storage, `avatars/${user.uid}-${file.name}`);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        updates.avatarUrl = url;
      }

      await update(ref(db, 'users/' + user.uid), updates);
      alert("Profil diperbarui");
    }

    const uploadPost = async () => {
      const file = fileInput.files[0];
      if (!file) return;
      const user = auth.currentUser;
      const userSnap = await get(ref(db, 'users/' + user.uid));
      const userData = userSnap.val();
      const name = userData?.name || user.email;

      const fileRef = sRef(storage, `uploads/${user.uid}-${file.name}`);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);

      const newPostRef = push(ref(db, 'posts'));
      const time = new Date().toLocaleString();
      const postData = {
        name, time,
        title: uploadTitleInput.value,
        description: uploadDescriptionInput.value,
        url, type: file.type
      };

      await set(newPostRef, postData);

      // Tambah notifikasi
      const notifRef = push(ref(db, 'notifications'));
      await set(notifRef, {
        title: "Unggahan Baru!",
        message: `${name} mengunggah: ${postData.title}`,
        time
      });

      alert("Berhasil upload!");
      switchTab("home");
      loadHomeFeed();
    }

    onAuthStateChanged(auth, async user => {
      if (user) {
        loginSection.hidden = registerSection.hidden = true;
        mainSection.hidden = false;

        const snap = await get(ref(db, 'users/' + user.uid));
        if (snap.exists()) {
          profileName.value = snap.val().name || "";
          profileEmail.value = snap.val().email || user.email;
        }
        loadHomeFeed();
      } else {
        mainSection.hidden = true;
        loginSection.hidden = false;
      }
    });

    window.register = register;
    window.login = login;
    window.updateProfile = updateProfile;
    window.uploadPost = uploadPost;
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans bg-gray-100 p-4 text-sm">
  <div id="loginSection">
    <h2 class="text-xl mb-2">Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" class="mb-2 p-2 border w-full" required />
    <input type="password" id="loginPassword" placeholder="Password" class="mb-2 p-2 border w-full" required />
    <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
    <p class="mt-2 text-sm">Belum punya akun? <a href="#" onclick="loginSection.hidden=true;registerSection.hidden=false;" class="text-blue-600 underline">Daftar</a></p>
  </div>

  <div id="registerSection" hidden>
    <h2 class="text-xl mb-2">Register</h2>
    <input type="email" id="registerEmail" placeholder="Email" class="mb-2 p-2 border w-full" required />
    <input type="password" id="registerPassword" placeholder="Password" class="mb-2 p-2 border w-full" required />
    <button onclick="register()" class="bg-green-600 text-white px-4 py-2 rounded">Register</button>
    <p class="mt-2 text-sm">Sudah punya akun? <a href="#" onclick="loginSection.hidden=false;registerSection.hidden=true;" class="text-blue-600 underline">Login</a></p>
  </div>

  <div id="mainSection" hidden>
    <div class="flex gap-4 mb-4">
      <button class="tab px-4 py-2 bg-white border rounded" data-tab="home">Home</button>
      <button class="tab px-4 py-2 bg-white border rounded" data-tab="upload">Upload</button>
      <button class="tab px-4 py-2 bg-white border rounded" data-tab="profile">Profil</button>
    </div>

    <div id="home" class="section"></div>

    <div id="upload" class="section" hidden>
      <input type="file" id="fileInput" class="mb-2" accept="image/*,video/*" />
      <input type="text" id="uploadTitleInput" placeholder="Judul" class="mb-2 p-2 border w-full" />
      <textarea id="uploadDescriptionInput" placeholder="Deskripsi" class="mb-2 p-2 border w-full"></textarea>
      <button id="uploadBtn" onclick="uploadPost()" class="bg-blue-500 text-white px-4 py-2 rounded">Upload</button>
    </div>

    <div id="profile" class="section" hidden>
      <input type="text" id="profileName" placeholder="Nama" class="mb-2 p-2 border w-full" />
      <input type="email" id="profileEmail" placeholder="Email" class="mb-2 p-2 border w-full" />
      <input type="file" id="profileImage" class="mb-2" accept="image/*" />
      <button onclick="updateProfile()" class="bg-yellow-500 text-white px-4 py-2 rounded">Simpan</button>
      <button onclick="logout()" class="mt-4 text-red-600 text-sm underline">Keluar</button>
    </div>
  </div>
</body>
</html>
