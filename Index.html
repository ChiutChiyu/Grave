<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glovish - Bagikan Momenmu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* CSS Anda yang sudah ada */
        body {
            font-family: -apple-system, BlinkMacMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
            color: #262626;
        }

        .hidden {
            display: none !important;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background-color: white;
            border-bottom: 1px solid #dbdbdb;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .top-bar h1 {
            font-size: 24px;
            margin: 0;
        }

        .top-bar .icon-button {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #262626;
        }

        .content {
            padding-top: 50px;
            padding-bottom: 60px;
        }

        .post {
            background-color: white;
            border: 1px solid #dbdbdb;
            margin-bottom: 10px;
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 10px 16px;
        }

        .post-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .post-username {
            font-weight: bold;
        }

        .post-media {
            width: 100%;
            display: block;
        }

        .post-actions {
            padding: 8px 16px;
        }

        .post-actions .icon-button {
            margin-right: 10px;
        }

        .post-likes {
            font-weight: bold;
            padding: 0 16px 8px;
            font-size: 14px;
        }

        .post-caption {
            padding: 0 16px 10px;
            font-size: 14px;
        }

        .post-comments {
            padding: 0 16px 10px;
            font-size: 13px;
            color: #8e8e8e;
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            background-color: white;
            border-top: 1px solid #dbdbdb;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .bottom-nav .icon-button {
            font-size: 24px;
            color: #262626;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Modal gaya umum */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }

        /* Gaya untuk modal upload */
        .upload-modal-content {
            text-align: center;
        }

        .upload-modal-content input[type="file"] {
            margin-bottom: 15px;
        }

        .upload-modal-content textarea {
            width: calc(100% - 20px);
            height: 80px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            resize: vertical;
        }

        .upload-modal-content button {
            background-color: #0095f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .upload-modal-content button:hover {
            opacity: 0.9;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
            flex-direction: column;
            gap: 15px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gaya untuk login/register */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #fafafa;
        }

        .auth-box {
            background-color: white;
            border: 1px solid #dbdbdb;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .auth-box h2 {
            margin-bottom: 20px;
            color: #262626;
        }

        .auth-box input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            background-color: #fafafa;
        }

        .auth-box button {
            width: 100%;
            padding: 10px;
            background-color: #0095f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .auth-box button:hover {
            opacity: 0.9;
        }

        .auth-box p {
            font-size: 14px;
        }

        .auth-box a {
            color: #0095f6;
            text-decoration: none;
            font-weight: bold;
        }
        
        /* Tambahan gaya untuk halaman profil */
        .profile-container {
            display: none;
            padding: 16px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        .profile-stats {
            display: flex;
            flex-grow: 1;
            justify-content: space-around;
        }
        
        .profile-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-stat-count {
            font-weight: bold;
            font-size: 18px;
        }
        
        .profile-stat-label {
            font-size: 14px;
            color: #8e8e8e;
        }
        
        .profile-edit-btn, .logout-btn {
            background-color: #f0f0f0;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            padding: 6px 12px;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            cursor: pointer;
        }

        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            margin-top: 15px;
        }
        
        .profile-bio {
            margin-bottom: 20px;
        }
        
        .profile-posts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }
        
        .profile-post {
            aspect-ratio: 1;
            background-color: #fafafa;
            position: relative;
            overflow: hidden;
        }
        
        .profile-post img, .profile-post video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Modal Edit Profil */
        .edit-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 200;
            display: none;
            flex-direction: column;
        }
        
        .edit-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #dbdbdb;
        }
        
        .edit-profile-header button {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .edit-profile-header #save-profile-btn {
            color: #0095f6;
        }

        .edit-profile-header #cancel-edit-profile-btn {
            color: #262626;
        }
        
        .edit-profile-content {
            padding: 16px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .edit-profile-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .edit-profile-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .edit-profile-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .edit-profile-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            background-color: #fafafa;
        }
        
        .edit-profile-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 14px;
        }

        #change-avatar-btn {
            background: none;
            border: none;
            color: #0095f6;
            font-weight: bold;
            cursor: pointer;
            font-size: 15px;
        }

        /* Online status indicator */
        #online-status {
            position: fixed;
            bottom: 60px;
            right: 10px;
            padding: 8px 16px;
            background: #333;
            color: white;
            border-radius: 20px;
            z-index: 1000;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        #online-status.offline {
            background: #f44336;
        }

        /* Alert style */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border-radius: 4px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { top: -50px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay hidden" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Memuat...</p>
    </div>

    <div id="main-app" class="hidden">
        <div class="top-bar">
            <h1>Glovish</h1>
            <button class="icon-button"><i class="far fa-paper-plane"></i></button>
        </div>

        <div class="content" id="mobile-content">
            <!-- Feed content will be loaded here -->
        </div>

        <div class="bottom-nav">
            <button class="icon-button" id="home-btn"><i class="fas fa-home"></i></button>
            <button class="icon-button"><i class="fas fa-search"></i></button>
            <button class="icon-button" id="upload-btn"><i class="fas fa-plus-square"></i></button>
            <button class="icon-button"><i class="fas fa-heart"></i></button>
            <button class="icon-button" id="profile-btn"><i class="fas fa-user-circle"></i></button>
        </div>

        <div class="modal hidden" id="upload-modal">
            <div class="modal-content upload-modal-content">
                <button class="modal-close-button" id="close-upload-modal">&times;</button>
                <h2>Buat Postingan Baru</h2>
                <input type="file" id="upload-file-input" accept="image/*,video/*">
                <textarea id="upload-caption-input" placeholder="Tulis keterangan..."></textarea>
                <button id="submit-post-btn">Bagikan</button>
            </div>
        </div>
    </div>

    <div class="auth-container" id="auth-container">
        <div class="auth-box">
            <h2 id="auth-title">Login</h2>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-password" placeholder="Password">
            <button id="auth-submit-btn">Login</button>
            <p id="auth-toggle-text">Belum punya akun? <a href="#" id="auth-toggle-link">Daftar</a></p>
        </div>
    </div>
    
    <div class="profile-container" id="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                <img id="profile-avatar-img" src="https://randomuser.me/api/portraits/lego/1.jpg" alt="Foto Profil">
                <button class="profile-avatar-edit" id="edit-avatar-btn">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                </button>
            </div>
            <div class="profile-stats">
                <div class="profile-stat">
                    <span class="profile-stat-count" id="post-count">0</span>
                    <span class="profile-stat-label">Postingan</span>
                </div>
                <div class="profile-stat">
                    <span class="profile-stat-count" id="follower-count">0</span>
                    <span class="profile-stat-label">Pengikut</span>
                </div>
                <div class="profile-stat">
                    <span class="profile-stat-count" id="following-count">0</span>
                    <span class="profile-stat-label">Mengikuti</span>
                </div>
            </div>
        </div>
        
        <div class="profile-bio">
            <h3 id="profile-username">Username</h3>
            <p id="profile-bio-text">Bio pengguna akan muncul di sini</p>
        </div>
        
        <button class="profile-edit-btn" id="edit-profile-btn">Edit Profil</button>
        <button class="logout-btn" id="logout-btn">Log Out</button> 
        
        <div class="profile-posts" id="profile-posts">
            <!-- User posts will be loaded here -->
        </div>
    </div>
    
    <div class="edit-profile-modal" id="edit-profile-modal">
        <div class="edit-profile-header">
            <button id="cancel-edit-profile-btn">Batal</button>
            <h3>Edit Profil</h3>
            <button id="save-profile-btn">Simpan</button>
        </div>
        
        <div class="edit-profile-content">
            <div class="edit-profile-avatar">
                <div class="edit-profile-avatar-preview">
                    <img id="edit-avatar-preview" src="" alt="Foto Profil">
                </div>
                <button id="change-avatar-btn">Ubah Foto Profil</button>
                <input type="file" id="edit-avatar-input" accept="image/*" style="display: none;">
            </div>
            
            <div class="edit-profile-form">
                <label for="edit-username">Username</label>
                <input type="text" id="edit-username" placeholder="Username">
                
                <label for="edit-bio">Bio</label>
                <input type="text" id="edit-bio" placeholder="Tulis bio Anda">
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, addDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-storage.js";
        import { enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgOPD5DDtjExQaVeu6VLFI7CMP9i8VOQw",
            authDomain: "projectchat01-d16bc.firebaseapp.com",
            databaseURL: "https://projectchat01-d16bc-default-rtdb.firebaseio.com",
            projectId: "projectchat01-d16bc",
            storageBucket: "projectchat01-d16bc.appspot.com",
            messagingSenderId: "163313653543",
            appId: "1:163313653543:web:5a4c8b70d6dedb8011bb02",
            measurementId: "G-M8JFL7S0TV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Enable Firestore offline persistence
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Persistensi offline hanya bisa diaktifkan di satu tab");
                } else if (err.code == 'unimplemented') {
                    console.log("Browser tidak mendukung persistensi offline");
                }
            });

        // Cache Manager
        const cacheManager = {
            set: (key, data, ttl = 24 * 60 * 60 * 1000) => {
                const item = {
                    data: data,
                    expiry: Date.now() + ttl
                };
                localStorage.setItem(`glovish_${key}`, JSON.stringify(item));
            },

            get: (key) => {
                const itemStr = localStorage.getItem(`glovish_${key}`);
                if (!itemStr) return null;
                
                const item = JSON.parse(itemStr);
                if (Date.now() > item.expiry) {
                    localStorage.removeItem(`glovish_${key}`);
                    return null;
                }
                return item.data;
            },

            remove: (key) => {
                localStorage.removeItem(`glovish_${key}`);
            },

            clearAll: () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('glovish_')) {
                        localStorage.removeItem(key);
                    }
                });
            }
        };

        // DOM Elements
        const mainApp = document.getElementById('main-app');
        const authContainer = document.getElementById('auth-container');
        const authTitle = document.getElementById('auth-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authToggleText = document.getElementById('auth-toggle-text');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mobileContent = document.getElementById('mobile-content');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadModal = document.getElementById('upload-modal');
        const closeUploadModalBtn = document.getElementById('close-upload-modal');
        const uploadFileInput = document.getElementById('upload-file-input');
        const uploadCaptionInput = document.getElementById('upload-caption-input');
        const submitPostBtn = document.getElementById('submit-post-btn');
        const profileContainer = document.getElementById('profile-container');
        const profileBtn = document.getElementById('profile-btn');
        const homeBtn = document.getElementById('home-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileAvatarImg = document.getElementById('profile-avatar-img');
        const profileUsername = document.getElementById('profile-username');
        const profileBioText = document.getElementById('profile-bio-text');
        const postCount = document.getElementById('post-count');
        const followerCount = document.getElementById('follower-count');
        const followingCount = document.getElementById('following-count');
        const profilePosts = document.getElementById('profile-posts');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const cancelEditProfileBtn = document.getElementById('cancel-edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const editAvatarPreview = document.getElementById('edit-avatar-preview');
        const editUsername = document.getElementById('edit-username');
        const editBio = document.getElementById('edit-bio');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const editAvatarInput = document.getElementById('edit-avatar-input');
        const avatarInput = document.getElementById('avatar-input');

        // State variables
        let isLoginMode = true;
        let currentUser = null;
        let userProfileData = null;

        // Utility functions
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showAlert(message, type = 'error') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function createOnlineStatusElement() {
            const onlineStatus = document.createElement('div');
            onlineStatus.id = 'online-status';
            document.body.appendChild(onlineStatus);
            return onlineStatus;
        }

        function updateOnlineStatus() {
            const onlineStatus = document.getElementById('online-status') || createOnlineStatusElement();
            
            if (navigator.onLine) {
                onlineStatus.textContent = 'Online';
                onlineStatus.style.background = '#4CAF50';
                onlineStatus.classList.remove('offline');
            } else {
                onlineStatus.textContent = 'Offline - Mode luring aktif';
                onlineStatus.style.background = '#f44336';
                onlineStatus.classList.add('offline');
            }
        }

        async function withRetry(fn, maxRetries = 3, delay = 1000) {
            let attempt = 0;
            let lastError;
            
            while (attempt < maxRetries) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    attempt++;
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw lastError;
        }

        // Authentication functions
        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            
            if (isLoginMode) {
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                authToggleText.innerHTML = 'Belum punya akun? <a href="#" id="auth-toggle-link">Daftar</a>';
            } else {
                authTitle.textContent = 'Daftar';
                authSubmitBtn.textContent = 'Daftar';
                authToggleText.innerHTML = 'Sudah punya akun? <a href="#" id="auth-toggle-link">Login</a>';
            }
        });

        authSubmitBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            
            if (!email || !password) {
                showAlert('Email dan password harus diisi');
                return;
            }
            
            showLoading();
            
            try {
                if (isLoginMode) {
                    await withRetry(() => signInWithEmailAndPassword(auth, email, password));
                } else {
                    const userCredential = await withRetry(() => createUserWithEmailAndPassword(auth, email, password));
                    await withRetry(() => setDoc(doc(db, 'users', userCredential.user.uid), {
                        username: email.split('@')[0],
                        bio: '',
                        avatarUrl: 'https://randomuser.me/api/portraits/lego/1.jpg',
                        followers: [],
                        following: [],
                        createdAt: serverTimestamp()
                    }));
                }
            } catch (error) {
                hideLoading();
                let errorMessage = error.message;
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Akun tidak ditemukan';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Password salah';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password terlalu lemah (minimal 6 karakter)';
                }
                
                showAlert(errorMessage);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                showAlert(`Error logging out: ${error.message}`);
            }
        });

        // Post functions
        uploadBtn.addEventListener('click', () => {
            uploadModal.classList.remove('hidden');
        });

        closeUploadModalBtn.addEventListener('click', () => {
            uploadModal.classList.add('hidden');
        });

        submitPostBtn.addEventListener('click', async () => {
            const file = uploadFileInput.files[0];
            const caption = uploadCaptionInput.value.trim();
            
            if (!file) {
                showAlert('Pilih file terlebih dahulu');
                return;
            }
            
            showLoading();
            
            try {
                if (navigator.onLine) {
                    await withRetry(() => uploadPost(file, caption));
                } else {
                    await withRetry(() => savePostForLater(file, caption));
                    showAlert('Postingan disimpan dan akan diunggah ketika online', 'info');
                }
                
                uploadFileInput.value = '';
                uploadCaptionInput.value = '';
                uploadModal.classList.add('hidden');
                
                loadUserPosts();
            } catch (error) {
                showAlert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        async function uploadPost(file, caption) {
            const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
            const uploadResult = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(uploadResult.ref);
            
            await addDoc(collection(db, 'posts'), {
                userId: currentUser.uid,
                mediaUrl: downloadURL,
                caption: caption,
                likes: [],
                comments: [],
                createdAt: serverTimestamp(),
                isVideo: file.type.includes('video')
            });
        }

        async function savePostForLater(file, caption) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const pendingPosts = cacheManager.get('pending_posts') || [];
                    
                    pendingPosts.push({
                        fileData: event.target.result,
                        fileName: file.name,
                        fileType: file.type,
                        caption: caption,
                        timestamp: Date.now()
                    });
                    
                    cacheManager.set('pending_posts', pendingPosts);
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        // Profile functions
        profileBtn.addEventListener('click', () => {
            mobileContent.classList.add('hidden');
            profileContainer.classList.remove('hidden');
        });

        homeBtn.addEventListener('click', () => {
            profileContainer.classList.add('hidden');
            mobileContent.classList.remove('hidden');
            loadFeedPosts();
        });

        editProfileBtn.addEventListener('click', () => {
            editUsername.value = userProfileData.username || '';
            editBio.value = userProfileData.bio || '';
            editAvatarPreview.src = userProfileData.avatarUrl || 'https://randomuser.me/api/portraits/lego/1.jpg';
            
            editProfileModal.style.display = 'flex';
        });

        cancelEditProfileBtn.addEventListener('click', () => {
            editProfileModal.style.display = 'none';
        });

        saveProfileBtn.addEventListener('click', async () => {
            showLoading();
            
            try {
                const updates = {
                    username: editUsername.value,
                    bio: editBio.value
                };
                
                if (editAvatarInput.files[0]) {
                    const file = editAvatarInput.files[0];
                    const storageRef = ref(storage, `avatars/${currentUser.uid}/${file.name}`);
                    const uploadResult = await uploadBytes(storageRef, file);
                    updates.avatarUrl = await getDownloadURL(uploadResult.ref);
                }
                
                await updateDoc(doc(db, 'users', currentUser.uid), updates);
                await loadProfileData();
                editProfileModal.style.display = 'none';
            } catch (error) {
                showAlert(`Error updating profile: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        changeAvatarBtn.addEventListener('click', () => {
            editAvatarInput.click();
        });

        editAvatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    editAvatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        avatarInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                showLoading();
                
                try {
                    const storageRef = ref(storage, `avatars/${currentUser.uid}/${file.name}`);
                    const uploadResult = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(uploadResult.ref);
                    
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        avatarUrl: downloadURL
                    });
                    
                    await loadProfileData();
                } catch (error) {
                    showAlert(`Error updating avatar: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }
        });

        // Data loading functions
        async function loadProfileData() {
            if (!currentUser) return;
            
            showLoading();
            
            try {
                const cachedProfile = cacheManager.get(`profile_${currentUser.uid}`);
                if (cachedProfile) {
                    userProfileData = cachedProfile;
                    updateProfileUI();
                }

                if (navigator.onLine) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        userProfileData = userDoc.data();
                        cacheManager.set(`profile_${currentUser.uid}`, userProfileData);
                        updateProfileUI();
                    }
                }

                await loadUserPosts();
            } catch (error) {
                console.error('Error loading profile data:', error);
                if (!userProfileData) {
                    showAlert('Gagal memuat data profil. Periksa koneksi internet Anda.');
                }
            } finally {
                hideLoading();
            }
        }

        function updateProfileUI() {
            if (!userProfileData) return;
            
            profileUsername.textContent = userProfileData.username || 'Username';
            profileBioText.textContent = userProfileData.bio || '';
            profileAvatarImg.src = userProfileData.avatarUrl || 'https://randomuser.me/api/portraits/lego/1.jpg';
            followerCount.textContent = userProfileData.followers?.length || 0;
            followingCount.textContent = userProfileData.following?.length || 0;
        }

        async function loadUserPosts() {
            if (!currentUser) return;
            
            try {
                const cachedPosts = cacheManager.get(`posts_${currentUser.uid}`);
                if (cachedPosts) {
                    displayPosts(cachedPosts);
                    postCount.textContent = cachedPosts.length;
                }

                if (navigator.onLine) {
                    const postsQuery = query(
                        collection(db, 'posts'),
                        where('userId', '==', currentUser.uid),
                        orderBy('createdAt', 'desc')
                    );
                    
                    const querySnapshot = await getDocs(postsQuery);
                    const posts = [];
                    querySnapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    postCount.textContent = posts.length;
                    displayPosts(posts);
                    cacheManager.set(`posts_${currentUser.uid}`, posts, 60 * 60 * 1000);
                }
            } catch (error) {
                console.error('Error loading user posts:', error);
                if (!cachedPosts) {
                    showAlert('Gagal memuat postingan. Periksa koneksi internet Anda.');
                }
            }
        }

        function displayPosts(posts) {
            profilePosts.innerHTML = '';
            
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'profile-post';
                
                if (post.isVideo) {
                    postElement.innerHTML = `<video src="${post.mediaUrl}" muted loop></video>`;
                } else {
                    postElement.innerHTML = `<img src="${post.mediaUrl}" alt="Post">`;
                }
                
                profilePosts.appendChild(postElement);
            });
        }

        async function loadFeedPosts() {
            if (!currentUser) return;
            
            showLoading();
            
            try {
                if (navigator.onLine) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    const following = userDoc.data()?.following || [];
                    following
